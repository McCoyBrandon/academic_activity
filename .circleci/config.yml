version: 2.1

jobs:
  build-and-push-frontend:
    docker:
      - image: docker:stable
    steps:
      - checkout
      
      - run:
          name: Install Dependencies
          command: npm install
          working_directory: Frontend/AcademicTool/components
      - run:
          name: Run Tests
          command: npm test
          working_directory: Frontend/AcademicTool/components

      - run:
          name: "Build Frontend Docker Image"
          command: |
            docker build -t harish492/frontend-image:latest -f Frontend/AcademicTool/Dockerfile .
      - run:
          name: "Save Frontend Image"
          command: |
            docker save -o frontend-image.tar harish492/frontend-image:latest
      - run:
          name: "Load and Push Frontend Image"
          command: |
            # docker load -i frontend-image.tar
            echo "$DOCKER_PASSWORD" | docker login --username $DOCKER_USERNAME --password-stdin
            docker push harish492/frontend-image:latest

  build-and-push-backend:
    docker:
      - image: docker:stable
    steps:
      - checkout
      
      - run:
          name: Install Dependencies
          command: npm install
          working_directory: Backend/backendAcademic
      - run:
          name: Run Tests
          command: npm test 
          working_directory: Backend/backendAcademic

      - run:
          name: "Build Backend Docker Image"
          command: |
            docker build -t harish492/backend-image:latest -f Backend/backendAcademic/Dockerfile .
      - run:
          name: "Save Backend Image"
          command: |
            docker save -o backend-image.tar harish492/backend-image:latest
      - run:
          name: "Load and Push Backend Image"
          command: |
            # docker load -i backend-image.tar
            echo "$DOCKER_PASSWORD" | docker login --username $DOCKER_USERNAME --password-stdin
            docker push harish492/backend-image:latest

workflows:
  version: 2
  Setup_and_Test:
    jobs:
      - build-and-push-frontend
      - build-and-push-backend
          filters:
            branches:
              only:
                - DockerHarry1
